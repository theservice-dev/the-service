{% liquid
  assign image_base_url = 'https://cdn.shopify.com/s/files/1/0749/4251/3290/files/Hero-A-1b.png?v=1770320017'
  assign image_reveal_url = 'https://cdn.shopify.com/s/files/1/0749/4251/3290/files/Hero-A-2.png?v=1770320018'
  
  if section.settings.image_base != blank
    assign base_image_src = section.settings.image_base | image_url: width: 3840
  else
    assign base_image_src = image_base_url
  endif

  if section.settings.image_reveal != blank
    assign reveal_image_src = section.settings.image_reveal | image_url: width: 3840
  else
    assign reveal_image_src = image_reveal_url
  endif

  comment
    Image position: map vertical (top/center/bottom) and horizontal (left/center/right) to CSS object-position and SVG preserveAspectRatio.
  endcomment
  assign v = section.settings.image_position_vertical
  assign h = section.settings.image_position_horizontal
  if v == 'top'
    assign pos_y = '0%'
    assign svg_y = 'YMin'
  elsif v == 'bottom'
    assign pos_y = '100%'
    assign svg_y = 'YMax'
  else
    assign pos_y = '50%'
    assign svg_y = 'YMid'
  endif
  if h == 'left'
    assign pos_x = '0%'
    assign svg_x = 'xMin'
  elsif h == 'right'
    assign pos_x = '100%'
    assign svg_x = 'xMax'
  else
    assign pos_x = '50%'
    assign svg_x = 'xMid'
  endif
  assign object_position = pos_x | append: ' ' | append: pos_y
  assign svg_preserve_aspect = svg_x | append: svg_y | append: ' slice'

  comment
    Content overlay: font family from preset (maps to theme CSS variables).
  endcomment
  assign title_font_var = '--font-heading--family'
  if section.settings.title_font == 'body'
    assign title_font_var = '--font-body--family'
  elsif section.settings.title_font == 'subheading'
    assign title_font_var = '--font-subheading--family'
  elsif section.settings.title_font == 'accent'
    assign title_font_var = '--font-accent--family'
  endif
  assign subtitle_font_var = '--font-heading--family'
  if section.settings.subtitle_font == 'body'
    assign subtitle_font_var = '--font-body--family'
  elsif section.settings.subtitle_font == 'subheading'
    assign subtitle_font_var = '--font-subheading--family'
  elsif section.settings.subtitle_font == 'accent'
    assign subtitle_font_var = '--font-accent--family'
  endif

  assign content_align = section.settings.content_alignment
  assign content_flex = 'center'
  assign content_text = 'center'
  assign gradient_direction = 'to top'
  
  if content_align == 'left'
    assign content_flex = 'flex-start'
    assign content_text = 'left'
    assign gradient_direction = 'to right'
  elsif content_align == 'right'
    assign content_flex = 'flex-end'
    assign content_text = 'right'
    assign gradient_direction = 'to left'
  endif
%}

<style>
  .section-{{ section.id }} {
    position: relative;
    width: 100vw;
    height: {{ section.settings.section_height }};
    overflow: hidden;
    background-color: #000;
    cursor: none; /* Hide default cursor for custom follower */
    --mask-size: {{ section.settings.mask_size }}px;
    --hero-mask-object-position: {{ object_position }};
    opacity: 0; /* Initial state for animation */
    visibility: hidden;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
  }

  .section-{{ section.id }} .hero-mask__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: var(--hero-mask-object-position);
    pointer-events: none;
    user-select: none;
    will-change: transform;
  }

  .hero-mask__svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2;
  }

  /* Custom cursor circle */
  .hero-mask__cursor {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 20px;
    border: 2px solid white;
    border-radius: 50%;
    pointer-events: none;
    z-index: 10;
    mix-blend-mode: difference;
    transform: translate(-50%, -50%);
    opacity: 0; /* Hidden initially until mouse enter */
  }

  /* Content overlay */
  .section-{{ section.id }} .hero-mask__content {
    position: absolute;
    inset: 0;
    z-index: 3;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: {{ content_flex }};
    padding: 1.5rem;
    pointer-events: none;
    color: {{ section.settings.text_color }};
  }
  
  {% if section.settings.enable_text_gradient %}
  .section-{{ section.id }} .hero-mask__content::before {
    content: "";
    position: absolute;
    inset: 0;
    z-index: -1;
    background: linear-gradient({{ gradient_direction }}, {{ section.settings.overlay_color }}, transparent);
    pointer-events: none;
  }
  {% endif %}

  .section-{{ section.id }} .hero-mask__content .hero-mask__cta { pointer-events: auto; }
  .section-{{ section.id }} .hero-mask__content-inner {
    max-width: 42rem;
    text-align: {{ content_text }};
  }
  .section-{{ section.id }} .hero-mask__title {
    font-family: var({{ title_font_var }});
    font-size: {{ section.settings.title_font_size }};
    margin: 0 0 0.5rem;
    color: inherit;
    {% if section.settings.enable_text_shadow %}
    text-shadow: {{ section.settings.text_shadow_x }}px {{ section.settings.text_shadow_y }}px {{ section.settings.text_shadow_blur }}px {{ section.settings.text_shadow_color }};
    {% endif %}
  }
  .section-{{ section.id }} .hero-mask__subtitle {
    font-family: var({{ subtitle_font_var }});
    font-size: {{ section.settings.subtitle_font_size }};
    margin: 0 0 1rem;
    color: inherit;
    opacity: 0.95;
    {% if section.settings.enable_text_shadow %}
    text-shadow: {{ section.settings.text_shadow_x }}px {{ section.settings.text_shadow_y }}px {{ section.settings.text_shadow_blur }}px {{ section.settings.text_shadow_color }};
    {% endif %}
  }
  .section-{{ section.id }} .hero-mask__cta {
    display: inline-block;
    margin-top: 0.25rem;
    padding: 0.75rem 1.5rem;
    font-size: {{ section.settings.cta_font_size }};
    font-family: var(--font-body--family);
    text-decoration: none;
    border-radius: var(--style-border-radius-buttons-primary, 0.25rem);
    border: 2px solid var(--color-primary-button-border, rgba(255, 255, 255, 0.9));
    background: var(--color-primary-button-background, #fff);
    color: var(--color-primary-button-text, #000);
    transition: opacity 0.2s ease, background 0.2s ease, color 0.2s ease;
  }
  .section-{{ section.id }} .hero-mask__cta:hover {
    background: var(--color-primary-button-hover-background, rgba(255, 255, 255, 0.9));
    color: var(--color-primary-button-hover-text, #000);
  }
</style>

<div class="section-{{ section.id }} hero-mask-section" id="HeroMask-{{ section.id }}" data-grow-on-click="{{ section.settings.grow_mask_on_click }}" data-grow-size="{{ section.settings.mask_grow_size }}" data-rest-size="{{ section.settings.mask_rest_size }}" data-resting-position-x="{{ section.settings.mask_resting_position_x }}" data-resting-position-y="{{ section.settings.mask_resting_position_y }}">
  <!-- Base Image (Bottom Layer) -->
  <img src="{{ base_image_src }}" alt="Hero Base" class="hero-mask__image hero-mask__base" width="3840" height="2160" loading="eager">

  <!-- Reveal Image (Top Layer - Masked via SVG) -->
  <svg class="hero-mask__svg" width="100%" height="100%" preserveAspectRatio="none">
    <defs>
      <!-- Turbulence Filter -->
      <filter id="turbulence-{{ section.id }}">
        <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="2" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="95" />
      </filter>
      
      <!-- Mask Definition (r starts at 0, animated to full size on load) -->
      <mask id="mask-{{ section.id }}">
        <circle id="mask-circle-{{ section.id }}" cx="50%" cy="50%" r="0" fill="white" filter="url(#turbulence-{{ section.id }})" data-mask-size="{{ section.settings.mask_size }}" />
      </mask>
    </defs>
    
    <!-- Masked Image -->
    <image href="{{ reveal_image_src }}" width="100%" height="100%" preserveAspectRatio="{{ svg_preserve_aspect }}" mask="url(#mask-{{ section.id }})" />
  </svg>
  
  <!-- Content overlay (title, subtitle, CTA) -->
  {% if section.settings.title != blank or section.settings.subtitle != blank or section.settings.cta_label != blank %}
  <div class="hero-mask__content" aria-labelledby="hero-mask-title-{{ section.id }}">
    <div class="hero-mask__content-inner">
      {% if section.settings.title != blank %}
        <h2 id="hero-mask-title-{{ section.id }}" class="hero-mask__title">{{ section.settings.title }}</h2>
      {% endif %}
      {% if section.settings.subtitle != blank %}
        <p class="hero-mask__subtitle">{{ section.settings.subtitle }}</p>
      {% endif %}
      {% if section.settings.cta_label != blank %}
        <a href="{{ section.settings.cta_link | default: '#' }}" class="hero-mask__cta">
          {{ section.settings.cta_label }}
        </a>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Custom Cursor -->
  <div class="hero-mask__cursor"></div>
</div>

<!-- Load GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const section = document.querySelector("#HeroMask-{{ section.id }}");
    const sectionContainer = document.querySelector(".section-{{ section.id }}");
    const maskCircle = document.querySelector("#mask-circle-{{ section.id }}");
    const turbulence = document.querySelector("#turbulence-{{ section.id }} feTurbulence");
    const cursor = section.querySelector(".hero-mask__cursor");
    const baseImage = section.querySelector(".hero-mask__base");
    
    if (!section || !maskCircle || !cursor) return;

    const maskSize = Number(maskCircle.getAttribute("data-mask-size")) || 300;
    const restSize = Number(section.getAttribute("data-rest-size")) ?? 0;
    const restXPercent = Number(section.getAttribute("data-resting-position-x")) ?? 50;
    const restYPercent = Number(section.getAttribute("data-resting-position-y")) ?? 50;

    // Full-size radius to cover entire section (diagonal from center)
    const rect = section.getBoundingClientRect();
    const fullSize = Math.ceil(Math.sqrt(rect.width * rect.width + rect.height * rect.height)) + 50;

    // Resting position coordinates (percent to pixels)
    const restX = (rect.width * restXPercent) / 100;
    const restY = (rect.height * restYPercent) / 100;

    // Entrance Animation: fade in section, mask shrinks from full picture to rest size, base image scales
    gsap.set(maskCircle, { attr: { r: fullSize } });
    const tl = gsap.timeline();
    tl.to(sectionContainer, { autoAlpha: 1, duration: 0.8, ease: "power2.inOut" })
      .to(maskCircle, { attr: { r: restSize }, duration: 1.2, ease: "power2.out" }, "-=0.3")
      .from(baseImage, { scale: 1.1, duration: 1.2, ease: "power2.out" }, "-=1.2");

    // Continuous turbulence animation
    if (turbulence) {
      gsap.to(turbulence, {
        attr: { baseFrequency: 0.03 },
        duration: 10,
        repeat: -1,
        yoyo: true,
        ease: "sine.inOut"
      });
    }

    // Initial position (resting position)
    const initialX = restX;
    const initialY = restY;

    // Cursor movement
    const xCursorTo = gsap.quickTo(cursor, "x", { duration: 0.1, ease: "power3" });
    const yCursorTo = gsap.quickTo(cursor, "y", { duration: 0.1, ease: "power3" });
    
    // Mask position (follows mouse; updated on tick for smooth follow)
    const maskPos = { x: initialX, y: initialY };
    const xMaskObjTo = gsap.quickTo(maskPos, "x", { duration: 0.2, ease: "power3" });
    const yMaskObjTo = gsap.quickTo(maskPos, "y", { duration: 0.2, ease: "power3" });
    
    gsap.set(maskCircle, { attr: { cx: maskPos.x, cy: maskPos.y } });
    gsap.set(cursor, { x: maskPos.x, y: maskPos.y });

    gsap.ticker.add(() => {
      maskCircle.setAttribute("cx", maskPos.x);
      maskCircle.setAttribute("cy", maskPos.y);
    });

    section.addEventListener("mousemove", (e) => {
      const rect = section.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      xMaskObjTo(x);
      yMaskObjTo(y);
      xCursorTo(x);
      yCursorTo(y);
    });
    
    section.addEventListener("mouseenter", () => {
      gsap.to(cursor, { autoAlpha: 1, duration: 0.3 });
      gsap.to(maskCircle, { attr: { r: maskSize }, duration: 0.4, ease: "power2.out" });
    });
    
    section.addEventListener("mouseleave", () => {
      const r = section.getBoundingClientRect();
      const rx = (r.width * restXPercent) / 100;
      const ry = (r.height * restYPercent) / 100;
      gsap.to(cursor, { autoAlpha: 0, duration: 0.3 });
      gsap.to(maskCircle, { attr: { r: restSize }, duration: 0.4, ease: "power2.out" });
      xMaskObjTo(rx);
      yMaskObjTo(ry);
    });

    // Grow mask on click (optional)
    const growOnClick = section.getAttribute("data-grow-on-click") === "true";
    const growSize = Number(section.getAttribute("data-grow-size")) || 400;
    let isGrown = false;

    if (growOnClick) {
      section.style.cursor = "pointer";
      section.addEventListener("click", (e) => {
        const rect = section.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        if (isGrown) {
          gsap.to(maskCircle, { attr: { r: maskSize }, duration: 0.5, ease: "power2.out" });
          maskPos.x = x;
          maskPos.y = y;
          xMaskObjTo(x);
          yMaskObjTo(y);
          isGrown = false;
        } else {
          xMaskObjTo(x);
          yMaskObjTo(y);
          gsap.to(maskCircle, { attr: { r: growSize }, duration: 0.5, ease: "power2.out" });
          isGrown = true;
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Hero Mask",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "image_picker",
      "id": "image_base",
      "label": "Base Image",
      "info": "The image visible by default (background)."
    },
    {
      "type": "image_picker",
      "id": "image_reveal",
      "label": "Reveal Image",
      "info": "The image revealed inside the mask."
    },
    {
      "type": "range",
      "id": "mask_size",
      "min": 100,
      "max": 600,
      "step": 10,
      "unit": "px",
      "label": "Mask size (when hovering)",
      "default": 300
    },
    {
      "type": "range",
      "id": "mask_rest_size",
      "min": 0,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Mask size when not hovering",
      "default": 0,
      "info": "Radius when the cursor is outside the section (0 = hidden)."
    },
    {
      "type": "range",
      "id": "mask_resting_position_x",
      "label": "Resting position X",
      "info": "Horizontal position when not hovering (0% = left, 100% = right).",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 50
    },
    {
      "type": "range",
      "id": "mask_resting_position_y",
      "label": "Resting position Y",
      "info": "Vertical position when not hovering (0% = top, 100% = bottom).",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "default": 50
    },
    {
      "type": "checkbox",
      "id": "grow_mask_on_click",
      "label": "Grow mask on click",
      "default": false
    },
    {
      "type": "range",
      "id": "mask_grow_size",
      "min": 200,
      "max": 800,
      "step": 20,
      "unit": "px",
      "label": "Size when grown",
      "default": 500,
      "info": "Radius the mask grows to when section is clicked (if grow on click is enabled)."
    },
    {
      "type": "header",
      "content": "Image position"
    },
    {
      "type": "select",
      "id": "image_position_vertical",
      "label": "Vertical position",
      "options": [
        { "value": "top", "label": "Top" },
        { "value": "center", "label": "Center" },
        { "value": "bottom", "label": "Bottom" }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "image_position_horizontal",
      "label": "Horizontal position",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "section_height",
      "label": "Section Height",
      "options": [
        {
          "value": "50vh",
          "label": "Small (50vh)"
        },
        {
          "value": "60vh",
          "label": "Medium (60vh)"
        },
        {
          "value": "70vh",
          "label": "Large (70vh)"
        },
        {
          "value": "100vh",
          "label": "Full Screen (100vh)"
        }
      ],
      "default": "60vh"
    },
    {
      "type": "header",
      "content": "Content overlay"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title"
    },
    {
      "type": "select",
      "id": "title_font",
      "label": "Title font",
      "options": [
        { "value": "heading", "label": "Heading" },
        { "value": "body", "label": "Body" },
        { "value": "subheading", "label": "Subheading" },
        { "value": "accent", "label": "Accent" }
      ],
      "default": "heading"
    },
    {
      "type": "select",
      "id": "title_font_size",
      "label": "Title font size",
      "options": [
        { "value": "1.25rem", "label": "Small" },
        { "value": "1.5rem", "label": "Medium" },
        { "value": "2rem", "label": "Large" },
        { "value": "2.5rem", "label": "Extra large" },
        { "value": "3rem", "label": "Display" }
      ],
      "default": "2rem"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle"
    },
    {
      "type": "select",
      "id": "subtitle_font",
      "label": "Subtitle font",
      "options": [
        { "value": "heading", "label": "Heading" },
        { "value": "body", "label": "Body" },
        { "value": "subheading", "label": "Subheading" },
        { "value": "accent", "label": "Accent" }
      ],
      "default": "body"
    },
    {
      "type": "select",
      "id": "subtitle_font_size",
      "label": "Subtitle font size",
      "options": [
        { "value": "0.875rem", "label": "Small" },
        { "value": "1rem", "label": "Medium" },
        { "value": "1.125rem", "label": "Large" }
      ],
      "default": "1rem"
    },
    {
      "type": "text",
      "id": "cta_label",
      "label": "Call to action label"
    },
    {
      "type": "url",
      "id": "cta_link",
      "label": "Call to action link"
    },
    {
      "type": "select",
      "id": "cta_font_size",
      "label": "Button font size",
      "options": [
        { "value": "0.875rem", "label": "Small" },
        { "value": "1rem", "label": "Medium" }
      ],
      "default": "1rem"
    },
    {
      "type": "select",
      "id": "content_alignment",
      "label": "Content alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Text shadow"
    },
    {
      "type": "checkbox",
      "id": "enable_text_shadow",
      "label": "Enable text shadow",
      "default": false
    },
    {
      "type": "color",
      "id": "text_shadow_color",
      "label": "Shadow color",
      "default": "#000000",
      "alpha": true
    },
    {
      "type": "range",
      "id": "text_shadow_blur",
      "label": "Shadow blur",
      "min": 0,
      "max": 24,
      "step": 2,
      "unit": "px",
      "default": 8
    },
    {
      "type": "range",
      "id": "text_shadow_x",
      "label": "Shadow offset X",
      "min": -12,
      "max": 12,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "text_shadow_y",
      "label": "Shadow offset Y",
      "min": -12,
      "max": 12,
      "step": 1,
      "unit": "px",
      "default": 2
    },
    {
      "type": "header",
      "content": "Gradient overlay"
    },
    {
      "type": "checkbox",
      "id": "enable_text_gradient",
      "label": "Enable gradient overlay",
      "default": false
    },
    {
      "type": "color",
      "id": "overlay_color",
      "label": "Overlay color",
      "default": "#000000",
      "alpha": true
    }
  ],
  "presets": [
    {
      "name": "Hero Mask"
    }
  ]
}
{% endschema %}
