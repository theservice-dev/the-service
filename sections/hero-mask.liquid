{% liquid
  assign image_base_url = 'https://cdn.shopify.com/s/files/1/0749/4251/3290/files/Hero-A-1b.png?v=1770320017'
  assign image_reveal_url = 'https://cdn.shopify.com/s/files/1/0749/4251/3290/files/Hero-A-2.png?v=1770320018'
  
  if section.settings.image_base != blank
    assign base_image_src = section.settings.image_base | image_url: width: 3840
  else
    assign base_image_src = image_base_url
  endif

  if section.settings.image_reveal != blank
    assign reveal_image_src = section.settings.image_reveal | image_url: width: 3840
  else
    assign reveal_image_src = image_reveal_url
  endif

  comment
    Image position: map vertical (top/center/bottom) and horizontal (left/center/right) to CSS object-position and SVG preserveAspectRatio.
  endcomment
  assign v = section.settings.image_position_vertical
  assign h = section.settings.image_position_horizontal
  if v == 'top'
    assign pos_y = '0%'
    assign svg_y = 'YMin'
  elsif v == 'bottom'
    assign pos_y = '100%'
    assign svg_y = 'YMax'
  else
    assign pos_y = '50%'
    assign svg_y = 'YMid'
  endif
  if h == 'left'
    assign pos_x = '0%'
    assign svg_x = 'xMin'
  elsif h == 'right'
    assign pos_x = '100%'
    assign svg_x = 'xMax'
  else
    assign pos_x = '50%'
    assign svg_x = 'xMid'
  endif
  assign object_position = pos_x | append: ' ' | append: pos_y
  assign svg_preserve_aspect = svg_x | append: svg_y | append: ' slice'
%}

<style>
  .section-{{ section.id }} {
    position: relative;
    width: 100vw;
    height: {{ section.settings.section_height }};
    overflow: hidden;
    background-color: #000;
    cursor: none; /* Hide default cursor for custom follower */
    --mask-size: {{ section.settings.mask_size }}px;
    --hero-mask-object-position: {{ object_position }};
    opacity: 0; /* Initial state for animation */
    visibility: hidden;
    left: 50%;
    right: 50%;
    margin-left: -50vw;
    margin-right: -50vw;
  }

  .section-{{ section.id }} .hero-mask__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: var(--hero-mask-object-position);
    pointer-events: none;
    user-select: none;
    will-change: transform;
  }

  .hero-mask__svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 2;
  }

  /* Custom cursor circle */
  .hero-mask__cursor {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 20px;
    border: 2px solid white;
    border-radius: 50%;
    pointer-events: none;
    z-index: 10;
    mix-blend-mode: difference;
    transform: translate(-50%, -50%);
    opacity: 0; /* Hidden initially until mouse enter */
  }
</style>

<div class="section-{{ section.id }} hero-mask-section" id="HeroMask-{{ section.id }}" data-grow-on-click="{{ section.settings.grow_mask_on_click }}" data-grow-size="{{ section.settings.mask_grow_size }}">
  <!-- Base Image (Bottom Layer) -->
  <img src="{{ base_image_src }}" alt="Hero Base" class="hero-mask__image hero-mask__base" width="3840" height="2160" loading="eager">

  <!-- Reveal Image (Top Layer - Masked via SVG) -->
  <svg class="hero-mask__svg" width="100%" height="100%" preserveAspectRatio="none">
    <defs>
      <!-- Turbulence Filter -->
      <filter id="turbulence-{{ section.id }}">
        <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="1" result="noise" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="30" />
      </filter>
      
      <!-- Mask Definition (r starts at 0, animated to full size on load) -->
      <mask id="mask-{{ section.id }}">
        <circle id="mask-circle-{{ section.id }}" cx="50%" cy="50%" r="0" fill="white" filter="url(#turbulence-{{ section.id }})" data-mask-size="{{ section.settings.mask_size }}" />
      </mask>
    </defs>
    
    <!-- Masked Image -->
    <image href="{{ reveal_image_src }}" width="100%" height="100%" preserveAspectRatio="{{ svg_preserve_aspect }}" mask="url(#mask-{{ section.id }})" />
  </svg>
  
  <!-- Custom Cursor -->
  <div class="hero-mask__cursor"></div>
</div>

<!-- Load GSAP -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const section = document.querySelector("#HeroMask-{{ section.id }}");
    const sectionContainer = document.querySelector(".section-{{ section.id }}");
    const maskCircle = document.querySelector("#mask-circle-{{ section.id }}");
    const turbulence = document.querySelector("#turbulence-{{ section.id }} feTurbulence");
    const cursor = section.querySelector(".hero-mask__cursor");
    const baseImage = section.querySelector(".hero-mask__base");
    
    if (!section || !maskCircle || !cursor) return;

    const maskSize = Number(maskCircle.getAttribute("data-mask-size")) || 300;

    // Entrance Animation: fade in section, then grow mask from 0 to full size and scale base image
    const tl = gsap.timeline();
    tl.to(sectionContainer, { autoAlpha: 1, duration: 0.8, ease: "power2.out" })
      .to(maskCircle, { attr: { r: maskSize }, duration: 1.2, ease: "power2.out" }, "-=0.3")
      .from(baseImage, { scale: 1.1, duration: 1.2, ease: "power2.out" }, "-=1.2");

    // Continuous turbulence animation
    if (turbulence) {
      gsap.to(turbulence, {
        attr: { baseFrequency: 0.02 },
        duration: 10,
        repeat: -1,
        yoyo: true,
        ease: "sine.inOut"
      });
    }

    // Initial position (center of section)
    const rect = section.getBoundingClientRect();
    const initialX = rect.width / 2;
    const initialY = rect.height / 2;

    // Cursor movement
    const xCursorTo = gsap.quickTo(cursor, "x", { duration: 0.1, ease: "power3" });
    const yCursorTo = gsap.quickTo(cursor, "y", { duration: 0.1, ease: "power3" });
    
    // Mask position (follows mouse; updated on tick for smooth follow)
    const maskPos = { x: initialX, y: initialY };
    const xMaskObjTo = gsap.quickTo(maskPos, "x", { duration: 0.2, ease: "power3" });
    const yMaskObjTo = gsap.quickTo(maskPos, "y", { duration: 0.2, ease: "power3" });
    
    gsap.set(maskCircle, { attr: { cx: maskPos.x, cy: maskPos.y } });
    gsap.set(cursor, { x: maskPos.x, y: maskPos.y });

    gsap.ticker.add(() => {
      maskCircle.setAttribute("cx", maskPos.x);
      maskCircle.setAttribute("cy", maskPos.y);
    });

    section.addEventListener("mousemove", (e) => {
      const rect = section.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      xMaskObjTo(x);
      yMaskObjTo(y);
      xCursorTo(x);
      yCursorTo(y);
    });
    
    section.addEventListener("mouseenter", () => {
      gsap.to(cursor, { autoAlpha: 1, duration: 0.3 });
    });
    
    section.addEventListener("mouseleave", () => {
       gsap.to(cursor, { autoAlpha: 0, duration: 0.3 });
    });

    // Grow mask on click (optional)
    const growOnClick = section.getAttribute("data-grow-on-click") === "true";
    const growSize = Number(section.getAttribute("data-grow-size")) || 400;
    let isGrown = false;

    if (growOnClick) {
      section.style.cursor = "pointer";
      section.addEventListener("click", (e) => {
        const rect = section.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        if (isGrown) {
          gsap.to(maskCircle, { attr: { r: maskSize }, duration: 0.5, ease: "power2.out" });
          maskPos.x = x;
          maskPos.y = y;
          xMaskObjTo(x);
          yMaskObjTo(y);
          isGrown = false;
        } else {
          xMaskObjTo(x);
          yMaskObjTo(y);
          gsap.to(maskCircle, { attr: { r: growSize }, duration: 0.5, ease: "power2.out" });
          isGrown = true;
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Hero Mask",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "image_picker",
      "id": "image_base",
      "label": "Base Image",
      "info": "The image visible by default (background)."
    },
    {
      "type": "image_picker",
      "id": "image_reveal",
      "label": "Reveal Image",
      "info": "The image revealed inside the mask."
    },
    {
      "type": "range",
      "id": "mask_size",
      "min": 100,
      "max": 600,
      "step": 10,
      "unit": "px",
      "label": "Mask Size",
      "default": 300
    },
    {
      "type": "checkbox",
      "id": "grow_mask_on_click",
      "label": "Grow mask on click",
      "default": false
    },
    {
      "type": "range",
      "id": "mask_grow_size",
      "min": 200,
      "max": 800,
      "step": 20,
      "unit": "px",
      "label": "Size when grown",
      "default": 500,
      "info": "Radius the mask grows to when section is clicked (if grow on click is enabled)."
    },
    {
      "type": "header",
      "content": "Image position"
    },
    {
      "type": "select",
      "id": "image_position_vertical",
      "label": "Vertical position",
      "options": [
        { "value": "top", "label": "Top" },
        { "value": "center", "label": "Center" },
        { "value": "bottom", "label": "Bottom" }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "image_position_horizontal",
      "label": "Horizontal position",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "section_height",
      "label": "Section Height",
      "options": [
        {
          "value": "50vh",
          "label": "Small (50vh)"
        },
        {
          "value": "60vh",
          "label": "Medium (60vh)"
        },
        {
          "value": "70vh",
          "label": "Large (70vh)"
        },
        {
          "value": "100vh",
          "label": "Full Screen (100vh)"
        }
      ],
      "default": "60vh"
    }
  ],
  "presets": [
    {
      "name": "Hero Mask"
    }
  ]
}
{% endschema %}
